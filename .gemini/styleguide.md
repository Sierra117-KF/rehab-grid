# リハぐり（Rehab-Grid）プロジェクトガイド

ユーザーへの出力は全て日本語で行ってください

## プロジェクト概要

### 目的

- リハビリテーションセラピストの「自主トレーニング指導箋」作成業務を効率化
- **完全クライアントサイド動作**でセキュリティを担保しつつ、Word より圧倒的に速い作成体験を提供

### コア・バリュー（Word/PPT に対する優位性）

- **自動レイアウト**: 画像を放り込むだけでグリッドが整列（位置調整不要）
- **定型文入力**: 「20 回 ×3 セット」「痛みが出たら中止」など頻出語句をワンタップで入力
- **完全ローカル**: サーバー送信なしで院内規定に抵触せず即日導入可能

---

## 技術スタック

### 基盤フレームワーク・ライブラリ

- `next` (16.x): `output: 'export'` モードで静的サイト生成
- `react` / `react-dom` (19.x)
- `typescript` (5.x)
- `tailwindcss` (4.x)
- `vitest`
- `@testing-library/react`
- `@vitest/browser-playwright`
- `eslint`
- `prettier`

#### 状態管理・データ永続化

- `zustand`: グローバル状態管理（軽量、ボイラープレート最小）
- `dexie`: IndexedDB のラッパー（画像・プロジェクトデータの永続化）
- `dexie-react-hooks`: Dexie の React フック統合（`useLiveQuery` 等）
- `zod`: スキーマバリデーション（JSON インポート時の型安全な検証）

#### UI コンポーネント（shadcn/ui）

- `@radix-ui/react-*`: shadcn/ui の基盤（アクセシブルなヘッドレスコンポーネント）
- `class-variance-authority`: コンポーネントバリアント管理
- `clsx`: クラス名の条件付き結合
- `tailwind-merge`: Tailwind クラスの競合解決
- `lucide-react`: アイコンライブラリ

#### 機能別ライブラリ

- `@dnd-kit/core`: ドラッグ＆ドロップのコア機能（カード型編集）
- `@dnd-kit/sortable`: ソート可能な D&D（順序入れ替え）
- `@dnd-kit/utilities`: D&D ユーティリティ関数
- `@react-pdf/renderer`: クライアントサイド PDF 生成（PDF 出力機能）
- `browser-image-compression`: ブラウザ内での画像圧縮・リサイズ（画像管理機能）
- `jszip`: クライアントサイドでの Zip ファイル生成（プロジェクトエクスポート）
- `dompurify`: HTMLサニタイズ（XSS対策・インポートデータ浄化）

#### ユーティリティ

- `nanoid`: 一意 ID 生成（item の id 用、軽量 130B）

---

### 設計方針

- `lib/`: アプリケーション固有のコアロジック（DB、Store、定数、スキーマ）
- `utils/`: 汎用的なヘルパー関数（他プロジェクトでも再利用可能なもの）

**ファイル配置の原則:**

- **定数**: 原則として`lib/constants/` に集約するが、コンポーネント固有で再利用性が低い定数など、管理上コロケーションする方が妥当な場合はこの限りではない
- **型定義**: 原則として`types/` に集約するが、コンポーネント固有の型定義は使用ファイル内で保持する
- **Zodスキーマ**: 原則として`lib/schemas/` に集約

**その他の設計原則:**

- **Route Groups `(editor)`**: URL に影響しないグループ化。`/training` として直接アクセス可能
- **Route Groups `(info)`**: 情報ページ用のルートグループ。`/privacy`、`/terms`、`/manual`、`/changelog` として直接アクセス可能。これらのページは静的コンテンツのみで、'use client' を使用しないサーバーコンポーネントとして実装する
- **バレルエクスポート**: `constants/index.ts`、`schemas/index.ts` で再エクスポートし、インポートを簡潔に
- **Colocation**: ページ固有のコンポーネントは `_components/` として同階層に配置可能

**情報ページの実装方針:**

- 利用規約・プライバシーポリシー・マニュアル・更新履歴の4ページは、インタラクティブな機能を持たない静的コンテンツページ
- Next.jsのサーバーコンポーネント（'use client'なし）として実装し、ビルド時に静的HTMLに変換
- これにより、JavaScriptバンドルサイズを削減し、ページ読み込みを高速化
- `output: 'export'` モードにより、静的ホスティング（Vercel, Cloudflare Pages等）へのデプロイが可能

**URL構造:**

- `/` - トップページ（アプリ紹介と自主トレーニング指導箋エディタへの導線）
- `/training` - 自主トレーニング指導箋エディタ
- `/privacy` - プライバシーポリシー
- `/terms` - 利用規約
- `/changelog` - 更新履歴

---

## 機能要件

### 画像管理機能

- **アップロード**: ローカルからのドラッグ＆ドロップ、またはファイル選択
- **クリップボード貼り付け（必須）**: ブラウザの別タブでコピーした画像を、キャンバス上で Ctrl+V（Mac: Cmd+V）するだけで直接配置できる機能。`navigator.clipboard` API または `onPaste` イベントハンドリングで実装
- **ローカルディレクトリ連携**: File System Access API を活用し、PC内の特定フォルダを選択してアプリ内のサイドバーに画像一覧を表示。これにより、エクスプローラーとアプリを行き来することなく、アプリ内で完結して画像をキャンバスへD&Dできる
  - **注意**: File System Access API は `https://` または `localhost` でのみ動作。HTTP 環境では利用不可
- **画像圧縮**: 取り込み時にブラウザ内で自動リサイズ・圧縮（長辺 1200px / WebP 推奨、JSON 肥大化防止）
- **ストック管理**: 取り込んだ画像を IndexedDB に保存し、「よく使う画像」としてライブラリ化（ブラウザ終了後も保持）

### 編集・レイアウト機能

- **テンプレート選択機能**: 新規作成時に用途に応じたプリセットテンプレートを選択可能
  - 例：「腰痛体操セット」「脳卒中 片麻痺用自主トレ」など
  - ゼロから作るのではなく、ある程度完成された状態から微修正するだけで資料が完成する体験を提供
- **グリッドテンプレート**: 「1列(大きな画像)」「2列×2行」「3列×4行」などをワンタップ切替
- **自動整列ロジック**: 座標（X, Y）を持たず、「並び順（Order）」と「選択したテンプレート」に基づいて自動配置。要素を削除・追加してもレイアウト崩れが起きず、自動で詰められる
- **カード型編集**: コンテンツを「カード」として扱い、D&D で順序入れ替え
- **入力フィールド（構造化データ）**:
  - タイトル（例: スクワット）
  - 画像
  - 方法・手順（テキストエリア）
  - 負荷・回数（回数・セット数・頻度の専用欄）
  - 注意点（リスク管理）
- **スニペット（定型文）挿入**: 例「呼吸を止めずに」「反動をつけずに」をワンクリック挿入

### 保存・復元機能

- **ブラウザ内保存**: リアルタイム／オートセーブで IndexedDB へ保存
  - **画像の内部保存形式**: IndexedDB には画像を **Blob** として保存（Base64 変換せず、ストレージ効率とパフォーマンスを確保）
- **プロジェクトのエクスポート**: 2種類のエクスポート形式を提供
  1. **軽量JSON形式（.json）**: テキストデータのみを含む軽量ファイル。画像は含まない。設定の共有や軽量バックアップ用途。同僚間でのテンプレート共有に最適
  2. **完全バックアップ形式（.zip）**: JSON + 画像ファイル群を zip 化してダウンロード。JSZip を使用し、画像は WebP 形式で圧縮して同梱。元画像を移動・削除してもデータが破損せず、ファイル単体での配布・共有が可能
- **プロジェクトのインポート**: 上記 JSON または ZIP を読み込み、編集状態を完全復元
  - **セキュリティ**: `zod` による厳格なスキーマバリデーションと `DOMPurify` による入力値サニタイズを強制適用し、不正データやXSS攻撃を防ぐ
- **マイテンプレート保存（将来拡張）**: ユーザーが作成したプロジェクトを「テンプレート」として保存し、次回以降の新規作成時にひな形として利用できる機能を想定

### PDF 出力機能

- **PDF生成方式**: `@react-pdf/renderer` でクライアントサイドで PDF バイナリを生成。ブラウザの `window.print()` には依存しない
- **プレビューとPDF出力の一致**: プリンタ環境によるレイアウト崩れのリスクを排除
- **印刷フロー**: PDF をダウンロード → ユーザーが PDF ビューア（Adobe Reader 等）から印刷
- **レイアウト**: A4 縦固定。ヘッダーに「氏名（手書き欄）」、フッターに「作成日」を配置
- **日本語フォント対応**: Noto Sans JP 等の日本語フォントを埋め込み。バンドルサイズ増加を考慮し、以下の対策を実施：
  - Web Worker での PDF 生成（メインスレッドをブロックしない）
  - フォントサブセット化による軽量化（常用漢字 + JIS第一水準 + 医療用語、目標700KB以下）
  - ビルドプロセスでのサブセット生成（fonttools/pyftsubset 等）

---

## 非機能要件

### セキュリティ・プライバシー

- **通信遮断**: クライアントサイドで完結し、外部 API への送信を一切行わない
- **Content Security Policy（CSP）**: 外部への通信を技術的にブロックするため、以下の CSP を設定

  ```
  default-src 'self';
  img-src 'self' blob: data:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' 'unsafe-inline';
  font-src 'self';
  connect-src 'self';
  worker-src 'self' blob:;
  frame-src 'self' blob:;
  object-src 'none';
  base-uri 'self';
  ```

- **フォント読み込み**: 日本語フォント（Noto Sans JP 等）は `public/fonts/` にローカル配置し、`font-src 'self'` で読み込む。Google Fonts 等の CDN は使用しない（CSP 違反となるため）。これにより完全オフライン動作も担保される
- **推奨利用環境**: セキュリティを強化したい場合は、Chrome の「ゲストモード」または「シークレットモード」での利用を推奨（ブラウザ拡張機能がデフォルトで無効になるため、悪意のある拡張機能によるデータ読み取りリスクを低減）
  - **注意**: シークレットモードでは IndexedDB のデータがセッション終了時にクリアされるため、必ず ZIP 形式でバックアップを取ること

### パフォーマンス

- **動作軽快性**: 画像 20 枚程度でも D&D や文字入力がカクつかない
- **ファイルサイズ**: 圧縮を徹底し、エクスポート JSON を 5〜10MB 以内に抑える

---

## 開発上の注意点

### 必須遵守事項

1. **外部API通信禁止**: ユーザー入力データ・画像データはサーバーに送信しない
2. **完全クライアントサイド動作**: 静的ファイル配信のみ（`output: 'export'`）

### 開発指針（3原則）

**すべてのコード実装において、以下の3原則を厳守すること:**

1. **DRY (Don't Repeat Yourself) **
   - 同じロジックが2箇所以上に存在する場合は、必ずリファクタリングを検討する

2. **KISS (Keep It Simple, Stupid) **
   - 不必要な複雑性を排除し、読みやすく理解しやすいコードを書く

3. **YAGNI (You Aren't Gonna Need It) **
   - 現在必要な機能のみを実装し、将来必要になるかもしれない機能は実際に必要になるまで実装しない

### コーディング規約

#### テストファイルの作成・編集に関する規約

- **テストファイルの作成・編集時は必ず `vitest-guideline` の Skills を使用すること**
- Skillsを使用できない場合は、`.claude\skills\vitest-guideline\SKILL.md`を直接参照すること
- jsdom環境では`.claude\skills\vitest-guideline\vitest-jsdom.md`を追加で参照すること
- browser環境では`.claude\skills\vitest-guideline\vitest-browser.md`を追加で参照すること

#### TypeScript 型チェック設定

- `strictTypeChecked`水準

#### ESLint規約

- **ESLintルールの緩和は原則禁止**
- `// eslint-disable`、`/* eslint-disable */`、設定ファイルでの `off` 等は使用しない
- どうしても緩和が必要な場合は、必ずユーザーに確認すること

#### JSDoc/TSDocドキュメント規約

- TypeScriptファイルの以下の要素にはJSDocコメントを付与すること（ESLint: warn）:
  - 関数宣言（FunctionDeclaration）
  - クラス（ClassDeclaration）
  - interface/type定義
  - exportされた関数・定数
- 型情報はTypeScriptの型システムを使用（JSDoc内で `@param {type}` のような型記述は不要）
- パラメータと戻り値の説明は任意だが、複雑なロジックには記述推奨
- TSDocの標準タグを使用: `@remarks`, `@example`, `@see`, `@public`, `@internal`

**注意**: Next.js特殊ファイル（page.tsx, layout.tsx等）、テストファイル、Storybookファイルはドキュメント不要

#### インポート規約

- パスエイリアス `@/` を使用（例: `@/components/...`, `@/lib/...`）
- 相対パスは同一ディレクトリ内のファイルのみに使用

#### エクスポート規約

- **原則**: 名前付きエクスポート（Named Export）を使用
- **例外**: Next.js特殊ファイルのみデフォルトエクスポート許可
  - `app/**/page.tsx`, `app/**/layout.tsx`, `app/**/error.tsx` 等
  - `next.config.js`, `tailwind.config.js` 等の設定ファイル

#### 命名規則

- **コンポーネント**: PascalCase
- **カスタムフック**: `use` + PascalCase
- **ユーティリティ関数**: camelCase
- **型定義**: PascalCase
- **定数**: SCREAMING_SNAKE_CASE

#### useEffect使用禁止

- **アプリケーションロジックにおける `useEffect` は原則禁止**
- 代替手段: データ取得→`useLiveQuery`、状態同期→Zustand Actions、操作反応→イベントハンドラ
- 例外（システム制御のみ）:
  - `beforeunload` イベントリスナーの登録
  - File System Access API の変更検知
  - ウィンドウリサイズ監視（`ResizeObserver` 含む）
  - `IntersectionObserver` の登録・解除
  - サードパーティライブラリ（dnd-kit 等）との統合ブリッジ
- 例外使用時はカスタムフックに隠蔽し、理由をコメントで明記

#### shadcn/ui コンポーネントのラッパー規約

shadcn/uiのアップデート時に既存のカスタマイズが失われないよう、ベースコンポーネントとプロジェクト固有のカスタマイズを分離する。

**ディレクトリ構成:**

- `components/ui/`: shadcn/ui ベースコンポーネント（**直接編集禁止** - アップデート時に上書き可能）
- `components/wrapped/`: プロジェクト固有のラッパーコンポーネント（カスタマイズ層）

**命名規則:**

- ファイル名: PascalCase（例: `Button.tsx`, `Input.tsx`）

**運用ルール:**

- カスタマイズが必要なコンポーネントのみラップする（全てをラップする必要はない）
- ラッパーは `ui/` をインポートして再エクスポート
- アプリケーションコードでは原則 `wrapped/` 経由で使用
  - 例外: Separator, Skeleton 等のカスタマイズ不要なコンポーネントは `ui/` から直接インポート可
